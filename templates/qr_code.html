{% extends "base.html" %}

{% block title %}QR Code - {{ registration.event.title }} - EventHub{% endblock %}

{% block styles %}
<style>
.qr-code-container {
    position: relative;
    display: inline-block;
}

.qr-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
}

.pending-qr {
    opacity: 0.4;
    filter: grayscale(100%);
}
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-body p-5">
                    <!-- Header -->
                    <div class="text-center mb-4">
                        <i class="fas fa-qrcode fa-3x text-primary mb-3"></i>
                        <h2 class="card-title">Event Registration QR Code</h2>
                        <p class="text-muted">Your digital ticket for {{ registration.event.title }}</p>
                        
                        <!-- Pass Approval Status -->
                        {% if registration.is_approved %}
                            {% if qr_code.is_approved %}
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>QR Pass Approved!</strong> Your pass is ready for use.
                                    {% if qr_code.approved_at %}
                                        <br><small>Approved on {{ qr_code.approved_at.strftime('%B %d, %Y at %I:%M %p') }}</small>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Registration Approved!</strong> Your QR pass is being generated.
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-clock me-2"></i>
                                <strong>Registration Pending Approval</strong>
                                <br>Your QR pass will be visible after the event host approves your registration.
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- QR Code Image -->
                    {% if qr_code.is_approved %}
                        <div class="text-center mb-4">
                            <div class="qr-code-container p-4 bg-light rounded">
                                <img src="data:image/png;base64,{{ qr_code.qr_data }}" 
                                     alt="QR Code" 
                                     class="img-fluid"
                                     style="max-width: 300px;">
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center mb-4">
                            <div class="qr-code-container p-4 bg-light rounded position-relative">
                                <img src="data:image/png;base64,{{ qr_code.qr_data }}" 
                                     alt="QR Code (Pending Approval)" 
                                     class="img-fluid pending-qr"
                                     style="max-width: 300px;">
                                <div class="qr-overlay">
                                    <span class="badge bg-warning fs-6 px-3 py-2">
                                        <i class="fas fa-clock me-1"></i>Pending Approval
                                    </span>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Event & Registration Details -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="fw-bold text-primary">Event Details</h6>
                            <p class="mb-2"><strong>Event:</strong> {{ registration.event.title }}</p>
                            <p class="mb-2"><strong>Date:</strong> {{ registration.event.date.strftime('%A, %B %d, %Y') }}</p>
                            <p class="mb-2"><strong>Time:</strong> {{ registration.event.time.strftime('%I:%M %p') }}</p>
                            <p class="mb-2"><strong>Location:</strong> {{ registration.event.location }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold text-primary">Registration Details</h6>
                            <p class="mb-2"><strong>Attendee:</strong> {{ registration.user.first_name }} {{ registration.user.last_name }}</p>
                            <p class="mb-2"><strong>Registration Date:</strong> {{ registration.registration_date.strftime('%B %d, %Y at %I:%M %p') }}</p>
                            <p class="mb-2"><strong>Status:</strong> 
                                <span class="badge bg-{{ 'success' if registration.status == 'confirmed' else 'warning' }}">
                                    {{ registration.status.title() }}
                                </span>
                            </p>
                            <p class="mb-2"><strong>QR Code Status:</strong> 
                                <span class="badge bg-{{ 'success' if qr_code.is_approved else 'warning' }}">
                                    {{ 'Approved & Active' if qr_code.is_approved else 'Pending Approval' }}
                                </span>
                                {% if qr_code.is_used %}
                                    <span class="badge bg-secondary ms-1">Used</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    
                    <!-- Verification Code -->
                    <div class="alert alert-info">
                        <h6 class="alert-heading">
                            <i class="fas fa-shield-alt me-2"></i>Verification Code
                        </h6>
                        <p class="mb-0">
                            <code>{{ qr_data.verification_code if qr_data.verification_code is defined else 'N/A' }}</code>
                        </p>
                        <small class="text-muted">Present this code along with your QR code for verification.</small>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-center mb-4">
                        {% if qr_code.is_approved %}
                            <a href="{{ url_for('download_qr_code', registration_id=registration.id) }}" 
                               class="btn btn-primary">
                                <i class="fas fa-download me-2"></i>Download QR Code
                            </a>
                        {% else %}
                            <button class="btn btn-secondary" disabled>
                                <i class="fas fa-download me-2"></i>Download Unavailable
                            </button>
                        {% endif %}
                        
                        {% if current_user.is_organizer and not qr_code.is_used %}
                            <a href="{{ url_for('verify_qr_code', registration_id=registration.id) }}" 
                               class="btn btn-success"
                               onclick="return confirm('Mark this QR code as verified/used?')">
                                <i class="fas fa-check me-2"></i>Verify QR Code
                            </a>
                        {% endif %}
                        
                        <a href="{{ url_for('event_detail', event_id=registration.event.id) }}" 
                           class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Event
                        </a>
                    </div>
                    
                    <!-- Usage Instructions -->
                    <div class="mt-4">
                        <h6 class="fw-bold">How to Use Your QR Code:</h6>
                        <ol class="text-muted">
                            <li>Save the QR code image to your phone or print it out.</li>
                            <li>Present the QR code at the event check-in.</li>
                            <li>The organizer will scan it to verify your registration.</li>
                            <li>Keep this QR code safe - it's your digital ticket!</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Print functionality
    function printQRCode() {
        window.print();
    }

    // Add print button dynamically
    const buttonContainer = document.querySelector('.d-grid.gap-2.d-md-flex');
    if (buttonContainer) {
        const printButton = document.createElement('button');
        printButton.className = 'btn btn-outline-primary';
        printButton.innerHTML = '<i class="fas fa-print me-2"></i>Print QR Code';
        printButton.onclick = printQRCode;
        buttonContainer.appendChild(printButton);
    }
});
</script>
{% endblock %}
